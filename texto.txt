






Email: admin@email.com
Senha: Admin123!



4) Proteger endpoints AJAX / ações que alteram estado (bloquear/ativar)

No teu dashboard tens funções JS que alteram o estado (bloquearutilizador, ativarutilizador) — não deixes isso só no cliente. Cria ações POST no AdminController protegidas por [Authorize(Roles = "Admin")] e ValidateAntiForgeryToken.

Exemplo de ações server-side:

[HttpPost]
[Authorize(Roles = "Admin")]
[ValidateAntiForgeryToken]
public async Task<IActionResult> BloquearUtilizador(int id, string motivo)
{
    var user = await _context.Utilizadores.FindAsync(id);
    if (user == null) return NotFound();

    user.Ativo = false;
    // opcional: registar motivo em tabela de logs
    await _context.SaveChangesAsync();

    return Json(new { success = true });
}

[HttpPost]
[Authorize(Roles = "Admin")]
[ValidateAntiForgeryToken]
public async Task<IActionResult> AtivarUtilizador(int id)
{
    var user = await _context.Utilizadores.FindAsync(id);
    if (user == null) return NotFound();

    user.Ativo = true;
    await _context.SaveChangesAsync();

    return Json(new { success = true });
}


E no JavaScript fazes fetch POST para esses endpoints, incluindo o token antiforgery. Uma forma simples: renderizar o token num meta no _Layout e ler no JS.

No _Layout.cshtml (no <head>):

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
<meta name="csrf-token" content="@Xsrf.GetAndStoreTokens(HttpContext).RequestToken" />


No JS:

function bloquearutilizador(id) {
    const motivo = prompt("Registar motivo do bloqueio:");
    if (!motivo) return;

    fetch('/Admin/BloquearUtilizador', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ id: id, motivo: motivo })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById("status" + id).textContent = "Bloqueado";
            alert("Utilizador bloqueado.");
        } else {
            alert("Erro ao bloquear.");
        }
    });
}


Isto evita que um utilizador não autorizado consiga invocar essas ações.

5) Esconder link no UI (já tens parcialmente)

No teu _Layout já mostras o menu condicionalmente. Usa User.IsInRole("Admin") para mostrar o link do painel apenas a admins:

@if (User.IsInRole("Admin"))
{
    <a asp-controller="Admin" asp-action="GerirUtilizadores">Painel Admin</a>
}


Mesmo que um utilizador veja o link, a validação server-side com [Authorize] é o que realmente protege o acesso.

6) Testes rápidos que deves fazer

Tentar aceder /Admin/GerirUtilizadores enquanto não autenticado → vai para login.

Logar como utilizador normal e tentar aceder → deve dar 403 ou ir para /Account/AccessDenied.

Logar como admin e aceder → deve funcionar.


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


(quando clico em agendar visita, see já tiver visita marcada, em vez de abrir a pagina de marcar visita, e só depois de tentar marcar é que aparece que já tenho uma visita marcada, aparece logo o pop up quando tento abrir essa pagina atraves da resultsinformationcar.cshtml (using AutoMarket.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;

namespace AutoMarket.Controllers
{
    public class VisitsController : Controller
    {
        private readonly AppDbContext _context;
        private readonly int _expHoras = 48; // prazo padrão

        public VisitsController(AppDbContext context)
        {
            _context = context;
        }

        // ===========================
        // 1. GET – Página para marcar visita
        // ===========================
        [HttpGet]
        public async Task<IActionResult> BookVisit(int id)
        {
            if (!User.Identity!.IsAuthenticated)
                return RedirectToAction("Login", "Account");

            var anuncio = await _context.Anuncios
                .Include(a => a.Modelo).ThenInclude(m => m.Marca)
                .Include(a => a.Vendedor).ThenInclude(v => v.Utilizador)
                .Include(a => a.Imagens)
                .FirstOrDefaultAsync(a => a.Id == id);

            if (anuncio == null)
                return NotFound();

            return View(anuncio);
        }

        // ===========================
        // 2. POST – Submeter agendamento
        // ===========================
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<IActionResult> BookVisit(int anuncioId, DateTime data, string hora)
        {
            if (!User.Identity!.IsAuthenticated)
                return RedirectToAction("Login", "Account");

            var comprador = await _context.Compradores
                .Include(c => c.Utilizador)
                .FirstOrDefaultAsync(c => c.Utilizador.Email == User.Identity.Name);

            var anuncio = await _context.Anuncios.FindAsync(anuncioId);

            if (comprador == null || anuncio == null)
                return NotFound();

            // 1️⃣ Validar data passada
            if (data.Date < DateTime.Today)
            {
                TempData["MensagemErro"] = "Não pode marcar visitas para datas anteriores à atual.";
                return RedirectToAction("BookVisit", new { id = anuncioId });
            }

            // 2️⃣ Validar horas passadas no próprio dia
            var dataHora = Combine(data, hora);
            if (data.Date == DateTime.Today && dataHora < DateTime.Now)
            {
                TempData["MensagemErro"] = "A hora selecionada já passou.";
                return RedirectToAction("BookVisit", new { id = anuncioId });
            }

            // 3️⃣ Evitar duplicação (mesmo comprador, mesmo anúncio)
            var visitaExistente = await _context.Reservas
                .AnyAsync(r => r.CompradorId == comprador.Id &&
                               r.AnuncioId == anuncioId &&
                               r.Estado == "Agendada");

            if (visitaExistente)
            {
                TempData["MensagemErro"] = "Já tem uma visita agendada para este anúncio.";
                return RedirectToAction("BookVisit", new { id = anuncioId });
            }

            // 4️⃣ Hora já está ocupada?
            var indisponivel = await _context.Reservas
                .AnyAsync(r => r.AnuncioId == anuncioId &&
                               r.DataHoraReserva == dataHora);

            if (indisponivel)
            {
                TempData["MensagemErro"] = "A hora selecionada já foi reservada por outro utilizador.";
                return RedirectToAction("BookVisit", new { id = anuncioId });
            }

            // 5️⃣ Criar reserva
            var reserva = new Reserva
            {
                CompradorId = comprador.Id,
                AnuncioId = anuncioId,
                Estado = "Agendada",
                PrazoExpiracao = DateTime.Now.AddHours(_expHoras),
                DataHoraReserva = dataHora
            };

            _context.Reservas.Add(reserva);
            await _context.SaveChangesAsync();

            TempData["MensagemSucesso"] = "Visita agendada com sucesso!";
            return View(await _context.Anuncios
                .Include(a => a.Modelo).ThenInclude(m => m.Marca)
                .Include(a => a.Imagens)
                .FirstOrDefaultAsync(a => a.Id == anuncioId));

        }

        private DateTime Combine(DateTime data, string hora)
        {
            var h = TimeSpan.Parse(hora);
            return data.Date + h;
        }

        // Horario disponivel apenas
        [HttpGet]
        public async Task<IActionResult> GetHorasIndisponiveis(int anuncioId, DateTime data)
        {
            var horasIndisponiveis = await _context.Reservas
                .Where(r => r.AnuncioId == anuncioId && r.DataHoraReserva.Date == data.Date)
                .Select(r => r.DataHoraReserva.ToString("HH:mm"))
                .ToListAsync();

            // horas passadas
            if (data.Date == DateTime.Today)
            {
                var agora = DateTime.Now.TimeOfDay;

                var horasFixas = new[] { "09:00", "10:00", "11:00", "14:00", "15:00", "16:00" };

                horasIndisponiveis.AddRange(
                    horasFixas.Where(h => TimeSpan.Parse(h) < agora)
                );
            }

            return Json(horasIndisponiveis);
        }


        // ===========================
        // 3. Histórico do comprador
        // ===========================
        //public async Task<IActionResult> VisitHistory()
        //{
        //    if (!User.Identity!.IsAuthenticated)
        //        return RedirectToAction("Login", "Account");

        //    var comprador = await _context.Compradores
        //        .Include(c => c.Utilizador)
        //        .FirstOrDefaultAsync(c => c.Utilizador.Email == User.Identity.Name);

        //    if (comprador == null)
        //        return RedirectToAction("Login", "Account");

        //    // Atualizar expirações automaticamente
        //    var reservas = await _context.Reservas
        //        .Include(r => r.Anuncio).ThenInclude(a => a.Modelo).ThenInclude(m => m.Marca)
        //        .Where(r => r.CompradorId == comprador.Id)
        //        .OrderByDescending(r => r.DataHoraReserva)
        //        .ToListAsync();

        //    foreach (var r in reservas)
        //    {
        //        if (r.PrazoExpiracao < DateTime.Now && r.Estado == "Agendada")
        //            r.Estado = "Expirada";
        //    }

        //    await _context.SaveChangesAsync();

        //    return View(reservas);
        //}
    }
}
) (@model AutoMarket.Models.Anuncio

@{
    ViewData["Title"] = $"{Model.Modelo?.Marca?.Nome ?? "Marca"} {Model.Modelo?.Nome ?? "Modelo"} - AutoMarket";
}

<link rel="stylesheet" href="~/css/resultsinformationcar.css" />

<main class="detail-container">
    <div class="car-content">
        <div class="car-info-header">
            <h1>@($"{Model.Modelo?.Marca?.Nome ?? "Marca"} {Model.Modelo?.Nome ?? "Modelo"}")</h1>
            @{
                string nomeLocal = string.IsNullOrEmpty(Model.Localizacao)
                ? "Portugal"
                : Model.Localizacao;
            }
            <div class="location">
                Anunciado a @Model.DataCriacao.ToString("dd 'de' MMMM 'de' yyyy")
            </div>
        </div>

        <div class="car-gallery">
            <div class="car-gallery-main">
                <img id="mainImage"
                     src="@(Model.Imagens != null && Model.Imagens.Any() ? Model.Imagens.First().UrlImagem : "/images/default-car.jpg")"
                     alt="@Model.Modelo?.Nome ?? " Carro"">
            </div>
            <div class="car-thumbnails">
                @if (Model.Imagens != null && Model.Imagens.Any())
                {
                    foreach (var img in Model.Imagens)
                    {
                        <img src="@img.UrlImagem" onclick="changeImage(this)" class="@(img == Model.Imagens.First() ? "active" : "")" />
                    }
                }
                else
                {
                    <img src="/images/default-car.jpg" class="active" />
                }
            </div>
        </div>

        <div class="content-section">
            <h2>Descrição do Veículo</h2>
            <div class="car-desc">
                <p>@Html.Raw((Model.Descricao ?? "Sem descrição disponível").Replace(Environment.NewLine, "<br />"))</p>
            </div>
        </div>
    </div>

    <div class="car-sidebar">
        <div class="summary-box">
            @if (User.Identity?.IsAuthenticated ?? false)
            {
                <span class="favorite-icon @(ViewBag.IsFavorito ? "favorited" : "")"
                      onclick="toggleFavorite(this, @Model.Id)">
                    &#10084;
                </span>
            }
            else
            {
                <span class="favorite-icon disabled" onclick="openGenericPopup('Faça login para adicionar aos favoritos.')">&#10084;</span>
            }
            <div class="car-price">@($"{Model.Preco:C}")</div>
            <ul class="specs-table">
                <li><strong>Marca</strong> <span>@Model.Modelo?.Marca?.Nome</span></li>
                <li><strong>Modelo</strong> <span>@Model.Modelo?.Nome</span></li>
                <li><strong>Ano</strong> <span>@Model.Ano</span></li>
                <li><strong>Quilometragem</strong> <span>@Model.Quilometragem?.ToString("N0") km</span></li>
                <li><strong>Caixa</strong> <span>@Model.Caixa</span></li>
                <li><strong>Combustível</strong> <span>@Model.Combustivel</span></li>
                <li><strong>Cor</strong> <span>@Model.Cor</span></li>
            </ul>
        </div>

        <div class="map-box">
            <h4>Localização do Veículo</h4>
            @if (!string.IsNullOrEmpty(Model.Localizacao))
            {
                <div class="map-embed">
                    <iframe width="100%"
                            height="250"
                            style="border:0; border-radius: 10px;"
                            loading="lazy"
                            allowfullscreen
                            referrerpolicy="no-referrer-when-downgrade"
                            src="https://www.google.com/maps/embed/v1/place?key=@ViewBag.GoogleMapsApiKey&q=@Uri.EscapeDataString(nomeLocal)">
                    </iframe>
                </div>
            }
            else   
            {
                <span>Localização não disponível.</span>
            }
        </div>

        <div class="contact-box">
            <h4>Interessado neste veículo?</h4>
            <button class="btn-contact" id="btnShowContact" onclick="showContact()">
                📞 Mostrar Telefone e Contactar
            </button>
            <div id="contactInfo" class="contact-info" style="display:none;">
                <p>
                    <strong>Telefone:</strong> <span id="sellerPhone">@((Model.Vendedor?.Contacto) ?? "Não disponível")</span>
                </p>
                <a href="https://wa.me/@Model.Vendedor?.Contacto"
                   target="_blank"
                   class="btn-whatsapp">💬 Falar no WhatsApp</a>
            </div>
            <button class="btn-visit" onclick="agendarVisita()">
                📅 Agendar Visita
            </button>
            <div class="seller-info">
                Anunciante: <strong>@Model.Vendedor?.Utilizador.Nome</strong><br>
            </div>
        </div>
    </div>
</main>

<!-- POPUP LOGIN GENÉRICO -->
<div id="genericLoginPopup" class="popup-overlay" style="display:none;">
    <div class="popup-box">
        <h3>⚠ Necessário Login</h3>
        <p id="genericLoginMessage">Faça login para continuar.</p>

        <div class="popup-buttons">
            <a href="/Account/Login" class="btn-login-popup">Login</a>
            <button onclick="closeGenericPopup()" class="btn-close-popup">Fechar</button>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        // Troca da imagem principal
        function changeImage(element) {
            document.getElementById('mainImage').src = element.src;
            document.querySelectorAll('.car-thumbnails img').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
        }

        // Favoritos
        function toggleFavorite(el, anuncioId) {
            fetch('/Favoritos/Toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `anuncioId=${anuncioId}`,
                credentials: 'include'
            })
            .then(async r => {
                if (!r.ok) {
                    const err = await r.json();
                    console.error(err);

                    if (r.status === 401) {
                        openGenericPopup("Faça login para adicionar anúncios aos favoritos.");
                        return;
                    }

                    alert("Erro ao atualizar favoritos: " + (err.error ?? "desconhecido"));
                    el.classList.remove('favorited'); // Reverter estado visual
                    return;
                }
                return r.json();
            })
            .then(data => {
                if (data && data.success) {
                    el.classList.toggle('favorited');
                }
            })
            .catch(err => {
                console.error(err);
                alert("Erro ao atualizar favoritos.");
                el.classList.remove('favorited');
            });
        }

        // Agendar visita
        function agendarVisita() {
            var isAuthenticated = @((User.Identity?.IsAuthenticated ?? false).ToString().ToLower());

            if (!isAuthenticated) {
                openGenericPopup("Faça login para agendar uma visita a este veículo.");
            } else {
                window.location.href = '/Visits/BookVisit?id=@Model.Id';
            }
        }

        // Mostrar/ocultar contato
        function showContact() {
            const btn = document.getElementById('btnShowContact');
            const contact = document.getElementById('contactInfo');

            if (contact.style.display === 'none') {
                contact.style.display = 'block';
                btn.innerText = '📱 Ocultar contacto';
                btn.style.background = 'linear-gradient(135deg, #1a2a6c 0%, #2948b1 100%)';
            } else {
                contact.style.display = 'none';
                btn.innerText = '📞 Mostrar Telefone e Contactar';
            }
        }

        // Pop-up genérico
        function openGenericPopup(message) {
            document.getElementById("genericLoginMessage").innerText = message;
            document.getElementById("genericLoginPopup").style.display = "flex";
        }

        function closeGenericPopup() {
            document.getElementById("genericLoginPopup").style.display = "none";
        }
    </script>
}
) (@model AutoMarket.Models.Anuncio

@{
    ViewData["Title"] = "Agendar Visita";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/bookvisit.css" />

<main class="visit-container">
    <div class="visit-card">

        <!-- TÍTULO -->
        <h2>Agendar Visita ao Veículo</h2>
        <p class="visit-subtitle">Escolha a data e hora para visitar o carro selecionado.</p>

        <!-- INFORMAÇÕES DO CARRO -->
        <div class="car-info-box">
            <img src="@Model.Imagens.FirstOrDefault()?.UrlImagem" class="car-img" />

            <div>
                <h3 class="car-title">@Model.Modelo.Marca.Nome @Model.Modelo.Nome</h3>
                <p class="car-price">@Model.Preco.ToString() €</p>
                <p class="car-details">
                    Ano: @Model.Ano | Quilómetros: @Model.Quilometragem.ToString() km
                </p>
            </div>
        </div>

        <!-- FORMULÁRIO -->
        <form asp-action="BookVisit" method="post" class="visit-form">
            <input type="hidden" name="anuncioId" value="@Model.Id" />

            <div class="form-row">
                <div>
                    <label>Data da Visita</label>
                    <input type="date" name="data" required />
                </div>

                <div>
                    <label>Hora da Visita</label>
                    <select id="horaSelect" name="hora" required>
                        <option value="" selected disabled>Selecione...</option>
                        <option value="09:00">09:00</option>
                        <option value="10:00">10:00</option>
                        <option value="11:00">11:00</option>
                        <option value="14:00">14:00</option>
                        <option value="15:00">15:00</option>
                        <option value="16:00">16:00</option>
                    </select>
                </div>
            </div>
            <p id="vagasDia" class="vagas-info"></p>

            <button type="submit" class="visit-btn">Confirmar Visita</button>
        </form>

    </div>
</main>

<!-- POPUP -->
<div id="popupOverlay" class="popup-overlay" style="display:none;">
    <div id="popupBox" class="popup-box">
        <h3 id="popupTitle">Mensagem</h3>
        <p id="popupMessage"></p>
        <button onclick="closePopup()" class="btn-close-popup">OK</button>
    </div>
</div>

@section Scripts {
    <script>
        // POPUP
        let redirectUrl = null;

        function showCustomPopup(title, message, redirect) {
            document.getElementById("popupTitle").textContent = title;
            document.getElementById("popupMessage").textContent = message;
            document.getElementById("popupOverlay").style.display = "flex";
            redirectUrl = redirect;
        }

        function closePopup() {
            document.getElementById("popupOverlay").style.display = "none";
            if (redirectUrl)
                window.location.href = redirectUrl;
        }

        // mensagens de erro/sucesso vindas do backend
        @if (TempData["MensagemErro"] != null)
        {
            <text>
                showCustomPopup(" ⚠ Erro ", "@TempData["MensagemErro"]");
            </text>
        }

        @if (TempData["MensagemSucesso"] != null)
        {
            <text>
                showCustomPopup("Visita Agendada!", "@TempData["MensagemSucesso"]",
                                "@Url.Action("Index", "Home")");
            </text>
        }


        // 🔵 DESATIVAR datas passadas
        const inputData = document.querySelector("input[name='data']");
        inputData.min = new Date().toISOString().split("T")[0];


        // 🔵 Atualizar horas disponíveis ao mudar a data
        inputData.addEventListener("change", function () {

            const data = this.value;
            const anuncioId = @Model.Id;
            const horaSelect = document.getElementById("horaSelect");
            const vagasLabel = document.getElementById("vagasDia");

            if (!data) return;

            fetch(`/Visits/GetHorasIndisponiveis?anuncioId=${anuncioId}&data=${data}`)
                .then(r => r.json())
                .then(horasIndisponiveis => {

                    let vagas = 0;

                    for (let opt of horaSelect.options) {
                        if (opt.value === "") continue;

                        if (horasIndisponiveis.includes(opt.value)) {
                            opt.disabled = true;
                            opt.classList.add("disabled-option");
                        } else {
                            opt.disabled = false;
                            opt.classList.remove("disabled-option");
                            vagas++;
                        }
                    }

                    // Mostrar número de vagas
                    if (vagas > 0) {
                        vagasLabel.textContent = `${vagas} horário(s) disponível(is) neste dia.`;
                        vagasLabel.style.color = "#2948b1";
                    } else {
                        vagasLabel.textContent = "Sem horários disponíveis neste dia.";
                        vagasLabel.style.color = "red";
                    }

                    horaSelect.value = "";
                });
        });
    </script>
}
)
)