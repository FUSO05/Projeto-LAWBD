@model IEnumerable<AutoMarket.Models.Anuncio>

@{
    ViewData["Title"] = "Resultados da Pesquisa - AutoMarket";
}

@section Styles {
    <link rel="stylesheet" href="~/css/searchresults.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
}

<main class="results-container">
    <aside class="filters-sidebar">
        <div class="filters-header">
            <h3>Filtros</h3>
            <button type="button" class="btn-reset" onclick="document.querySelector('form').reset();">Limpar</button>
        </div>

        <form method="get" asp-action="SearchResults" asp-controller="Search">
            <div class="filters-scroll">
                <div class="filter-group">
                    <label for="marca">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" />
                            <path d="M12 2v20M2 12h20" />
                        </svg>
                        Marca
                    </label>
                    <select id="marca" name="marca">
                        <option value="">Todas as marcas</option>
                        @foreach (var marca in (IEnumerable<string>)ViewBag.Marcas)
                        {
                            <option value="@marca">@marca</option>
                        }
                    </select>
                </div>

                <div class="filter-group">
                    <label for="modelo">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" />
                            <path d="M9 3v18M3 9h18M3 15h18M15 3v18" />
                        </svg>
                        Modelo
                    </label>
                    <select id="modelo" name="modelo">
                        <option value="">Todos os modelos</option>
                        @foreach (var modelo in (IEnumerable<string>)ViewBag.Modelos)
                        {
                            <option value="@modelo">@modelo</option>
                        }
                    </select>
                </div>

                <div class="filter-group">
                    <label for="categoria">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 7h16M4 12h16M4 17h16" />
                        </svg>
                        Categoria
                    </label>
                    <select id="categoria" name="categoria">
                        <option value="">Todas as categorias</option>
                        @foreach (var categoria in (IEnumerable<string>)ViewBag.Categorias)
                        {
                            <option value="@categoria">@categoria</option>
                        }
                    </select>
                </div>

                <div class="filter-group">
                    <label for="precoMin">Preço</label>
                    <div class="range-inputs">
                        <input type="number" name="precoMin" placeholder="Mínimo" min="0" value="@Context.Request.Query["precoMin"]" />
                        <input type="number" name="precoMax" placeholder="Máximo" min="0" value="@Context.Request.Query["precoMax"]" />
                    </div>
                </div>

                <div class="filter-group">
                    <label for="anoMin">Ano</label>
                    <div class="range-inputs">
                        <input type="number" name="anoMin" placeholder="Mínimo" min="1900" max="2100" value="@Context.Request.Query["anoMin"]" />
                        <input type="number" name="anoMax" placeholder="Máximo" min="1900" max="2100" value="@Context.Request.Query["anoMax"]" />
                    </div>
                </div>

                <div class="filter-group">
                    <label for="combustivel">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 22v-8a4 4 0 0 1 4-4h6a4 4 0 0 1 4 4v8" />
                            <path d="M14 10V6a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v4" />
                            <path d="M17 14l3-3-3-3" />
                        </svg>
                        Combustível
                    </label>
                    <select id="combustivel" name="combustivel">
                        <option value="">Todos os tipos</option>
                        @foreach (var c in (IEnumerable<string>)ViewBag.Combustiveis)
                        {
                            <option value="@c">@c</option>
                        }
                    </select>
                </div>

                <div class="filter-group">
                    <label for="caixa">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3" />
                            <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24" />
                        </svg>
                        Caixa
                    </label>
                    <select id="caixa" name="caixa">
                        <option value="">Todos os tipos</option>
                        @foreach (var c in (IEnumerable<string>)ViewBag.Caixas)
                        {
                            <option value="@c">@c</option>
                        }
                    </select>
                </div>

                <div class="filter-group">
                    <label for="localizacao">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                            <circle cx="12" cy="10" r="3" />
                        </svg>
                        Localização
                    </label>
                    <select id="localizacao" name="localizacao">
                        <option value="">Todas as localizações</option>
                        @foreach (var l in (IEnumerable<string>)ViewBag.Localizacoes)
                        {
                            <option value="@l">@l</option>
                        }
                    </select>
                </div>
            </div>

            <button type="submit" class="btn-filter">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
                </svg>
                Aplicar Filtros
            </button>
        </form>
    </aside>

    <section class="listings">
        <div class="results-header">
            <div class="results-count">
                <h1>Encontrados <span class="count-highlight">@Model.Count()</span> resultados</h1>
            </div>
    <div class="sort-bar">
        <form method="get" asp-action="SearchResults" asp-controller="Search">
            <!-- manter filtros ativos -->
                    <!-- manter filtros ativos -->
                    <input type="hidden" name="marca" value="@Context.Request.Query["marca"]" />
                    <input type="hidden" name="modelo" value="@Context.Request.Query["modelo"]" />
                    <input type="hidden" name="categoria" value="@Context.Request.Query["categoria"]" />
                    <input type="hidden" name="anoMin" value="@Context.Request.Query["anoMin"]" />
                    <input type="hidden" name="anoMax" value="@Context.Request.Query["anoMax"]" />
                    <input type="hidden" name="precoMin" value="@Context.Request.Query["precoMin"]" />
                    <input type="hidden" name="precoMax" value="@Context.Request.Query["precoMax"]" />
                    <input type="hidden" name="combustivel" value="@Context.Request.Query["combustivel"]" />
                    <input type="hidden" name="caixa" value="@Context.Request.Query["caixa"]" />
                    <input type="hidden" name="localizacao" value="@Context.Request.Query["localizacao"]" />

            <label for="ordenar">Ordenar:</label>
                @{
                    string ordenarAtual = ViewBag.OrdenarAtual as string ?? "recentes";
                }
                    <select id="ordenar" name="ordenar" onchange="this.form.submit()">
                        <option value="recentes" selected="@(ordenarAtual == "recentes")">Mais recentes</option>
                        <option value="preco_asc" selected="@(ordenarAtual == "preco_asc")">Menor preço</option>
                        <option value="preco_desc" selected="@(ordenarAtual == "preco_desc")">Maior preço</option>
                        <option value="ano_desc" selected="@(ordenarAtual == "ano_desc")">Ano mais recente</option>
                        <option value="ano_asc" selected="@(ordenarAtual == "ano_asc")">Ano mais antigo</option>
                    </select>
        </form>
    </div>
        </div>

        <div class="cars-grid">
            @foreach (var anuncio in Model)
            {
                <article class="car-card @(anuncio.Reservas?.Any(r => r.Estado == "Pago") == true ? "sold" : "")"
                         onclick="window.location.href='@Url.Action("ResultsInformationCar", "Search", new { id = anuncio.Id })'">
                    <div class="car-image-container">
                        <img src="@(anuncio.Imagens?.FirstOrDefault()?.UrlImagem)"
                             class="car-image"
                             alt="@($"{anuncio.Modelo.Marca.Nome} {anuncio.Modelo.Nome}")" />
                        <div class="car-badge">@anuncio.Ano</div>
                    </div>
                    <div class="car-content">
                        <div class="car-header">
                            <h2 class="car-title">@anuncio.Modelo.Marca.Nome</h2>
                            <p class="car-subtitle">@anuncio.Modelo.Nome</p>
                        </div>

                        <div class="car-price-section">
                            <span class="car-price">@($"{anuncio.Preco:C}")</span>
                        </div>

                        <div class="car-specs">
                            <div class="spec-item">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10" />
                                </svg>
                                <span>@(anuncio.Quilometragem?.ToString("N0") ?? "-") km</span>
                            </div>
                            <div class="spec-item">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 22v-8a4 4 0 0 1 4-4h6a4 4 0 0 1 4 4v8" />
                                </svg>
                                <span>@anuncio.Combustivel</span>
                            </div>
                            <div class="spec-item">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3" />
                                </svg>
                                <span>@anuncio.Caixa</span>
                            </div>
                            <div class="spec-item">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                                    <circle cx="12" cy="10" r="3" />
                                </svg>
                                <span>@anuncio.Localizacao</span>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(anuncio.Descricao))
                        {
                            <p class="car-desc">@anuncio.Descricao</p>
                        }
                    </div>
                </article>
            }
        </div>
    </section>
</main>

@section Scripts {
    <script>
        const marcaSelect = document.getElementById('marca');
        const modeloSelect = document.getElementById('modelo');

        marcaSelect.addEventListener('change', function () {
            const marca = this.value;
            modeloSelect.innerHTML = '<option value="">Todos os modelos</option>';

            if (marca) {
                fetch(`/Search/GetModelosByMarca?marca=${encodeURIComponent(marca)}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(modelo => {
                            const option = document.createElement('option');
                            option.value = modelo;
                            option.text = modelo;
                            modeloSelect.appendChild(option);
                        });
                    })
                    .catch(err => console.error(err));
            }
        });
    </script>
}